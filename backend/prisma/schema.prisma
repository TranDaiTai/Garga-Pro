// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
  output   = "../src/prisma/client"  // Or any relative/absolute path you prefer, e.g., "./generated/client"
}

datasource db {
  provider = "postgresql"
}

// ================================
// AUTH & USER
// ================================

model User {
  id           Int       @id @default(autoincrement())
  username     String    @unique @db.VarChar(100)
  email        String    @unique @db.VarChar(255)
  passwordHash String    @map("password_hash") @db.VarChar(255)
  fullName     String?   @map("full_name") @db.VarChar(255)
  phone        String?   @db.VarChar(20)
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @default(now()) @updatedAt @map("updated_at")

  // Relations
  reviews      Review[]
  addresses    Address[]
  cart         Cart?
  orders       Order[]

  @@map("users")
}

// ================================
// CATEGORIES
// ================================

model Category {
  id          Int       @id @default(autoincrement())
  name        String    @db.VarChar(255)
  description String?   @db.Text
  imageUrl    String?   @map("image_url") @db.Text

  products    Product[]

  @@map("categories")
}

// ================================
// PRODUCTS & IMAGES
// ================================

model Product {
  id              Int       @id @default(autoincrement())
  name            String    @db.VarChar(255)
  categoryId      Int?      @map("category_id")
  price           Decimal   @db.Decimal(12, 2)
  originalPrice   Decimal?  @map("original_price") @db.Decimal(12, 2)
  rating          Decimal   @default(0) @db.Decimal(3, 2)
  reviewsCount    Int       @default(0) @map("reviews_count")
  soldCount       Int       @default(0) @map("sold_count")
  description     String?   @db.Text
  fullDescription String?   @map("full_description") @db.Text
  features        Json?     @db.JsonB
  specifications  Json?     @db.JsonB
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at")

  // Relations
  category        Category?       @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  images          ProductImage[]
  reviews         Review[]
  cartItems       CartItem[]
  orderItems      OrderItem[]
  promotions      Promotion[]

  @@map("products")
}

model ProductImage {
  id         Int      @id @default(autoincrement())
  productId  Int      @map("product_id")
  imageUrl   String   @map("image_url") @db.Text
  isMain     Boolean  @default(false) @map("is_main")
  position   Int      @default(0)

  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_images")
}

// ================================
// REVIEWS
// ================================

model Review {
  id              Int      @id @default(autoincrement())
  productId       Int      @map("product_id")
  userId          Int?     @map("user_id")
  rating          Int
  title           String?  @db.VarChar(255)
  content         String?  @db.Text
  authorDisplay   String?  @map("author_display") @db.VarChar(100)
  location        String?  @db.VarChar(100)
  reviewDate      DateTime @default(now()) @map("review_date")
  likes           Int      @default(0)

  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user            User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  images          ReviewImage[]

  @@map("reviews")
}

model ReviewImage {
  id        Int     @id @default(autoincrement())
  reviewId  Int     @map("review_id")
  imageUrl  String  @map("image_url") @db.Text

  review    Review  @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@map("review_images")
}

// ================================
// PROMOTIONS / COUPONS
// ================================

model Promotion {
  id             Int       @id @default(autoincrement())
  code           String?   @unique @db.VarChar(50)
  name           String    @db.VarChar(255)
  discountType   String    @db.VarChar(20) // 'percentage' | 'fixed'
  discountValue  Decimal   @db.Decimal(12, 2)
  productId      Int?      @map("product_id")
  startDate      DateTime? @map("start_date")
  endDate        DateTime? @map("end_date")
  maxUsage       Int?      @map("max_usage")
  usedCount      Int       @default(0) @map("used_count")

  product        Product?  @relation(fields: [productId], references: [id], onDelete: Cascade)
  orders         Order[]

  @@map("promotions")
}

// ================================
// ADDRESS & CART
// ================================

model Address {
  id         Int     @id @default(autoincrement())
  userId     Int     @map("user_id")
  fullName   String? @map("full_name") @db.VarChar(255)
  phone      String? @db.VarChar(20)
  addressLine String  @map("address_line") @db.Text
  city       String? @db.VarChar(100)
  country    String  @default("Viá»‡t Nam") @db.VarChar(100)
  isDefault  Boolean @default(false) @map("is_default")

  user       User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders     Order[]

  @@map("addresses")
}

model Cart {
  id      Int       @id @default(autoincrement())
  userId  Int       @unique @map("user_id")

  user    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  items   CartItem[]

  @@map("carts")
}

model CartItem {
  id         Int      @id @default(autoincrement())
  cartId     Int      @map("cart_id")
  productId  Int      @map("product_id")
  quantity   Int
  addedAt    DateTime @default(now()) @map("added_at")

  cart       Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId])
  @@map("cart_items")
}

// ================================
// ORDERS & PAYMENTS
// ================================

model Order {
  id            Int       @id @default(autoincrement())
  userId        Int?      @map("user_id")
  addressId     Int?      @map("address_id")
  promotionId   Int?      @map("promotion_id")
  totalAmount   Decimal   @db.Decimal(12, 2) @map("total_amount")
  status        String    @default("pending") @db.VarChar(50)
  orderDate     DateTime  @default(now()) @map("order_date")

  user          User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  address       Address?  @relation(fields: [addressId], references: [id])
  promotion     Promotion? @relation(fields: [promotionId], references: [id])
  items         OrderItem[]
  payment       Payment?

  @@map("orders")
}

model OrderItem {
  id               Int      @id @default(autoincrement())
  orderId          Int      @map("order_id")
  productId        Int?     @map("product_id")
  quantity         Int
  priceAtPurchase  Decimal  @db.Decimal(12, 2) @map("price_at_purchase")
  subtotal         Decimal  @db.Decimal(12, 2)

  order            Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product          Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@map("order_items")
}

model Payment {
  id           Int      @id @default(autoincrement())
  orderId      Int      @unique @map("order_id")
  amount       Decimal  @db.Decimal(12, 2)
  method       String?  @db.VarChar(50)
  status       String   @default("pending") @db.VarChar(50)
  paymentDate  DateTime? @map("payment_date")

  order        Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payments")
}